<!--
(Не)очевидные трюки отладки фронтенда

Блог компании Lazada TechHub
JavaScript*
Веб-разработка*
Отладка*

отладка, devtools, chrome canary, firefox developer edition, browser-sync
-->

<img src="https://habrastorage.org/files/ec4/108/ab3/ec4108ab30d741d586570fdc8c6758cd.png">

Так получается, что большую часть времени разработчик тратит на отладку кода. Поэтому нужно уметь это делать, и делать это хорошо. Что бы вы могли сказать про отладку и фронтенд? Конечно же, console.log, debugger и еще десяток классных штук из DevTools. Теперь вы знаете, о чем будет половина этого текста ツ

А за остальным интригующе приглашаю под кат!
<cut>
<h2>Дисклеймер</h2>
Все будет в коротком виде – описание с применением. Многие трюки весьма просты, но это не является показателем их бесполезности. Подробности специально убраны под спойлер, чтобы туда смотрели, только если этот трюк неизвестен.

Приведенные примеры были сделаны в <a href="https://www.google.com/chrome/browser/canary.html">Chrome Canary</a> и <a href="https://www.mozilla.org/en-US/firefox/developer/">Firefox Developer Edition</a>, поэтому лучше установить эти версии браузеров. Так вы сможете уже сейчас пользоваться тем, что в стабильной версии появится только через 3 месяца.

<h3>Редактирование кода в браузере</h3>
Представим, что мы столкнулись с проблемой на лайве и изменять скрипты на сервере нет возможности. В таком случае мы можем попробовать изменить код до выполнения (и даже во время выполнения) в Chrome.
Для этого нужно поставить точку останова до интересующего нас кода, внести необходимые изменения, сохранить и продолжить выполнение.

Я сделал <a href="http://reepush.github.io/publications/obvious-frontend-debugging-tricks/demos/live-edit/live-edit.html">демку</a>. Попробуйте ее пройти, не заглядывая под спойлер.

<spoiler title="Как пройти демо">
<ol>
<li>Находим скрипт <i>live-edit.js</i> и ставим точку останова на строке 1</li>
<li>Перезагружаем страницу</li>
<li>Выполнение останавливается, и мы можем изменить значение переменной <i>isItEasy</i> на <i>true</i></li>
<li>После сохраняем (Ctrl + S)</li>
<li>Продолжаем выполнение</li>
</ol>
<img width="508" src="https://habrastorage.org/files/300/9b9/37a/3009b937aeab470f9e4a8c187fd3292a.gif">

Работает очень магически, ни один браузер, кроме Chrome, так делать не умеет. А именно – при изменении весь код в текущем контексте выполняется заново. Это нужно учитывать, ведь в некоторых случаях функции могут изменять внешнее состояние, и лишние изменения будут нежелательными.
Пример такого поведения можно посмотреть в <a href="http://reepush.github.io/publications/obvious-frontend-debugging-tricks/demos/live-edit/live-edit-scoping.html">этом демо</a>. Обратите внимание, что после изменения кода в консоли появится <i>IIFE executed 2 time</i>.
</spoiler>
К сожалению, с этим способом нельзя сохранить наши изменения при перезагрузке. Для чего-то более сложного лучше использовать прокси.

<h3>Подмена скриптов через прокси</h3>
Мы все так же на лайве, без доступов к скриптам. По сравнению с предыдущим примером нам нужно сделать более масштабные изменения, или может быть еще необходим препроцессинг нашего кода.
Будем делать все изменения локально и подменять скрипты с помощью BrowserSync. В <a href="https://gist.github.com/reepush/5d9bb62112b4bf183926">примере</a> будет подключен наш скрипт и стили на главную страницу Яндекса.

<spoiler title="Пример">
Клонируем пример, устанавливаем зависимости и запускаем:

<source>
git clone https://gist.github.com/5d9bb62112b4bf183926.git proxify-assets
cd proxify-assets
npm install
gulp
</source>
Теперь заходим на <a href="https://localhost:3000/">https://localhost:3000/</a> и видим всем знакомую страницу. Но только у нас еще подключено два файла: <i>custom.css</i> и <i>custom.js</i>. Попробуйте их изменить: BrowserSync автоматически перезагрузит страницу при изменении скрипта, а изменения стилей применятся мгновенно без перезагрузки.
В этом примере мы не заменяли внешние скрипты на локальные, но это очень просто сделать, лишь изменив <i>rewriteRules</i> в настройках BrowserSync.
</spoiler>
<h3>Подмена страниц в WebView</h3>
Для отладки девайсов нужно собрать специальный билд приложения, который позволит подключиться инспектором к WebView. У нас сборка может быть для лайва или стейджинга, а в таком случае нет возможности быстро вносить изменения и видеть результат.
Но мы можем подключиться инспектором и выполнить в консоли <i>window.location.href = 'http://your-dev.local'</i> и делать быстрые итерации на локальном окружении.

<spoiler title="Про старые Андройд девайсы">
Для Андройд девайсов подключиться инспектором можно только начиная с версии 4.4. В более старых версиях стоит попробовать воспроизвести проблему в браузере. Тут могут помочь трюки <i>Вылезаем из локальной сети</i> и <i>Эмулятор Андройд девайсов</i>.
</spoiler>
<h3>Отладка с помощью Valence</h3>
Valence является адаптером к различным браузерам (Safari на iOS, Firefox на Android, Chrome), приводящим различные протоколы к единому виду.
Таким образом можно всегда использовать привычный инструмент для отладки, либо же сделать его привычным ツ
Более подробно посмотреть, как использовать WebIDE вместе с Valence можно на <a href="https://developer.mozilla.org/en-US/docs/Tools/WebIDE/Setting_up_runtimes#Other_runtimes">MDN</a>.

C Chrome также можно подключаться к iOS, но по сравнению с WebIDE это выглядит довольно сложно.
Хочу заметить, что пока это больше экспериментальная возможность и работает не совсем стабильно. Но мне один раз пригодилась, когда нужно было заглянуть в Safari, а системы с Mac OS не было под рукой. Надеюсь, что в будущем протоколы отладки будут стандартизированы, и мы сможем пользоваться своими любимыми инструментами для отладки Node.js, например.

<h3>Вылезаем из локальной сети</h3>
С отладкой на различных браузерах и девайсах все просто – мы всегда имеем доступ к локальной сети. Все бы так и было, если бы не Опера Мини. Все запросы делаются с удаленных серверов Оперы, которым наши локальные ресурсы недоступны. Тут нам пригодится <a href="https://ngrok.com/">ngrok</a>, либо SSH-туннель если у нас есть свой хост.

<spoiler title="Консоль и конфиги">
<b>Используем ngrok</b>

<source>
ngrok http localhost:8000
</source>
Чтобы отдать наши локальные файлы мы можем использовать удобный <i>python -m SimpleHTTPServer</i>.
Но если мы хотим вынести наружу не просто статику, а сервер, то скорее всего пригодится такой параметр, как <i>host-header</i>. Все вместе будет выглядеть так:

<source lang="bash">
ngrok http -host-header=your-dev.local your-dev.local:80
</source>
<b>Используем SSH-туннель</b>

<source>
ssh -NR 0.0.0.0:8080:your-dev.local:80 your-host.external
</source>
После этого, обращаясь по адресу <a href="http://your-host.external:8080/">http://your-host.external:8080</a>, мы будем иметь доступ к локальному хосту.
Тут еще нужно не забыть про конфиг <i>/etc/ssh/sshd_config</i>. Более подробно об этом можно посмотреть <a href="http://blog.trackets.com/2014/05/17/ssh-tunnel-local-and-remote-port-forwarding-explained-with-examples.html">здесь</a>, но если кратко – нужно указать следующий параметр на сервере:

<source>
GatewayPorts clientspecified
</source>
</spoiler>
<h3>Букмарклет для повторяющихся действий</h3>
Мы делаем изменения и тестируем их, делаем изменения, опять тестируем... А тестирование в некоторых случаях весьма затратно по времени. Можно заскриптовать наши действия и выполнять их как букмарклет одним кликом.
Попробуем сделать автозаполнение формы. В <a href="http://reepush.github.io/publications/obvious-frontend-debugging-tricks/demos/bookmarklet-fill-form/bookmarklet-fill-form.html">этом примере</a> нужно заполнить необходимые параметры, указав форму и нужные значения. Сразу после изменения мы можем перетащить ссылку <i>Fill Form</i> к себе на панель закладок и с помощью нее заполнять свои формы.

<h3>Воспроизводим как тестировщики</h3>
Я уверен, что всем хотелось бы как можно меньше времени тратить на чтение <i>Steps To Reproduce</i>, а сразу увидеть проблему и приступить к ее решению. Как например, если тестировщик сидит рядом с нами и передает ноутбук, как только обнаруживает проблему.
Попытаемся описать состояние страницы, на которой находится тестировщик. Что мы можем сохранить:

<ul>
<li>Ссылку</li>
<li>Куки</li>
<li>Юзер-агент</li>
<li>Стек трейс</li>
<li>Разметку</li>
</ul>
<a href="http://reepush.github.io/publications/obvious-frontend-debugging-tricks/demos/bookmarklet-reproducible/bookmarklet-reproducible.html">Пример букмарклета</a>, который это делает. После нажатия на <i>Run reproducible</i>, снизу появится кнопка <i>Copy Info</i>, нажав на которую, мы получим всю необходимую информацию.

Это нужно сделать расширением к браузеру. Потому что с букмарклетом я уже вижу как минимум две проблемы, которые никак нельзя решить: логирование исключений до активации букмарклета и получение HttpOnly кук. Так что пока это просто набросок идеи, но может быть уже есть подобные решения?

<h3>Эмулятор Андройд девайсов</h3>
Как-то мне один специалист по тестированию показал прекрасный инструмент для эмуляции – <a href="https://www.genymotion.com/">Genymotion</a>. Там более 80 вариаций девайсов и версий, есть из чего выбрать. Мы так смогли воспроизвести баг, возникающий на версии 4.3, а таких девайсов у нас не было.

<h3>Mixed Content</h3>
Полезно помнить о возможности возникновения этой проблемы. Был такой случай:
<blockquote>
На Андройд девайсе в приложении всегда загружается плейсхолдер, а не изображение товара. На десктопе и мобильной версии не воспроизводится. Плейсхолдер вешается при событии error, то есть когда произошла ошибка загрузки оригинального изображения.
</blockquote>

Проблема с сетью у тестировщика и <i>Can't reproduce</i>?
Но оказалось, что приложение открывает страницу по HTTPS протоколу, а картинка загружается по обычному HTTP. Отлично, если бы срабатывал верный триггер на такого рода проблемы.

<h3>DevTools для самых внимательных</h3>
<table>
<tr>
<th>Описание</th>
<th>Скриншот</th>
</tr>

<tr>
<td>Пропускаем точки останова в текущем тике в Chrome</td>
<td><img width="273" src="https://habrastorage.org/files/050/d42/115/050d421158a14687905d414cc6135af4.png"></td>
</tr>

<tr>
<td>Подсветка измененных стилей в Firefox</td>
<td><img width="230" src="https://habrastorage.org/files/11c/eb2/e2f/11ceb2e2fc7e4cd596e90ad19dc8e2ea.png"></td>
</tr>

<tr>
<td>Переключение классов в Chrome</td>
<td><img width="329" src="https://habrastorage.org/files/76d/a44/81e/76da4481eef349eabb5301f22fb94ded.png"></td>
</tr>

<tr>
<td>Изменение способа описания цвета <i>(Shift + клик)</i></td>
<td><img width="275" src="https://habrastorage.org/files/518/4a5/5c2/5184a55c27d14ac09343b9c73e924715.png"></td>
</tr>

<tr>
<td>Обращение к выделенному элементу в инспекторе через <i>$0</i> (кое-кто не знал)</td>
<td><img width="406" src="https://habrastorage.org/files/6b1/161/386/6b116138609d4fbdb7a3c58b1c9e8249.png"></td>
</tr>

<tr>
<td>Скрытие элемента по хоткею <i>H</i> и скролл по <i>S</i></td>
<td></td>
</tr>
</table>
На этом все. А если вы знаете другие полезные трюки – обязательно поделитесь ими в комментариях!
